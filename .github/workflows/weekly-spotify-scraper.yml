name: Weekly Spotify Price Scraper

on:
  schedule:
    # æ¯å‘¨æ—¥UTCæ—¶é—´0ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´å‘¨æ—¥ä¸Šåˆ8ç‚¹ï¼‰
    - cron: '0 0 * * 0'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ å†™å…¥æƒé™ä»¥å…è®¸æ¨é€åˆ°ä»“åº“
permissions:
  contents: write
  actions: read
  id-token: write

env:
  TZ: Asia/Shanghai

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright and browsers
      env:
        PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright
      run: |
        # å®‰è£…åŸºç¡€ä¾èµ–å’Œè™šæ‹Ÿæ˜¾ç¤ºå™¨
        sudo apt-get update
        sudo apt-get install -y xvfb
        # æ˜¾ç¤ºå½“å‰Pythonå’ŒPlaywrightç‰ˆæœ¬
        echo "Python version: $(python --version)"
        echo "Playwright version: $(python -c 'import playwright; print(playwright.__version__)')"
        # å‚è€ƒå®˜æ–¹æ–¹å¼å®‰è£…ä¾èµ–
        npx playwright install-deps
        # è®¾ç½®æµè§ˆå™¨å®‰è£…è·¯å¾„å¹¶å®‰è£…æ‰€æœ‰æµè§ˆå™¨
        export PLAYWRIGHT_BROWSERS_PATH=/home/runner/.cache/ms-playwright
        python -m playwright install
        # éªŒè¯å®‰è£…
        python -c "
        from playwright.sync_api import sync_playwright
        import os
        with sync_playwright() as p:
            print('Chromium executable:', p.chromium.executable_path)
            if os.path.exists(p.chromium.executable_path):
                print('âœ… Chromium executable exists')
            else:
                print('âŒ Chromium executable NOT found')
                # Check actual browser cache location
                cache_path = '/home/runner/.cache/ms-playwright'
                if os.path.exists(cache_path):
                    print(f'Browser cache directory exists: {cache_path}')
                    import glob
                    chromium_dirs = glob.glob(f'{cache_path}/chromium*')
                    print(f'Found chromium directories: {chromium_dirs}')
                else:
                    print(f'Browser cache directory NOT found: {cache_path}')
        "
        # è®¾ç½®æµè§ˆå™¨è·¯å¾„ç¯å¢ƒå˜é‡
        export PLAYWRIGHT_BROWSERS_PATH=/home/runner/.cache/ms-playwright
        
    - name: Create output directory
      run: mkdir -p output
        
    - name: Run Spotify scraper
      id: scraper
      env:
        # Playwright ç¯å¢ƒå˜é‡ - ä½¿ç”¨æ­£ç¡®çš„æµè§ˆå™¨è·¯å¾„
        PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        # ç¡®ä¿headlessæ¨¡å¼
        DISPLAY: ":99"
      run: |
        echo "å¼€å§‹çˆ¬å–Spotifyä»·æ ¼æ•°æ®..."
        # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨
        sudo Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 2
        # æ£€æŸ¥Playwrightæµè§ˆå™¨å®‰è£…çŠ¶æ€
        echo "æ£€æŸ¥Playwrightæµè§ˆå™¨å®‰è£…..."
        python -c "
        from playwright.sync_api import sync_playwright
        import os
        with sync_playwright() as p:
            print('Available browsers:', p.chromium, p.firefox, p.webkit)
            print('Chromium executable path:', p.chromium.executable_path)
            if os.path.exists(p.chromium.executable_path):
                print('âœ… Chromium executable exists')
            else:
                print('âŒ Chromium executable NOT found')
        "
        # è¿è¡Œçˆ¬è™«
        python spotify.py
        echo "scraper_status=success" >> $GITHUB_OUTPUT
      continue-on-error: true
        
    - name: Check scraper output
      run: |
        if [ -f "spotify_prices_all_countries.json" ]; then
          echo "âœ… çˆ¬è™«æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          ls -la spotify_prices_all_countries*.json
        else
          echo "âŒ çˆ¬è™«æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
    - name: Run rate converter
      id: converter
      env:
        API_KEY: ${{ secrets.API_KEY }}
      run: |
        echo "å¼€å§‹æ±‡ç‡è½¬æ¢..."
        python spotify_rate_converter.py
        echo "converter_status=success" >> $GITHUB_OUTPUT
      continue-on-error: true
        
    - name: Check converter output
      run: |
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          echo "âœ… æ±‡ç‡è½¬æ¢æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          ls -la spotify_prices_cny_sorted.json
        else
          echo "âŒ æ±‡ç‡è½¬æ¢æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
    - name: Check for changes
      id: check_changes
      run: |
        git diff --name-only
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–"
        fi
        
    - name: Display summary
      run: |
        echo "=== æ‰§è¡Œæ‘˜è¦ ==="
        echo "æ—¥æœŸ: $(date +'%Y-%m-%d %H:%M:%S %Z')"
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          echo "è½¬æ¢åçš„æ•°æ®æ–‡ä»¶å¤§å°: $(du -h spotify_prices_cny_sorted.json | cut -f1)"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < spotify_prices_cny_sorted.json)"
        fi
        
    - name: Archive data with timestamp
      if: steps.scraper.outputs.scraper_status == 'success' && steps.converter.outputs.converter_status == 'success'
      run: |
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        YEAR=$(date +'%Y')
        MONTH=$(date +'%m')
        ARCHIVE_DIR="archive/${YEAR}/${MONTH}"
        mkdir -p ${ARCHIVE_DIR}
        echo "å¼€å§‹å½’æ¡£æ•°æ®åˆ° ${ARCHIVE_DIR}..."
        if [ -f "spotify_prices_all_countries.json" ]; then
          cp spotify_prices_all_countries.json "${ARCHIVE_DIR}/spotify_prices_all_countries_${TIMESTAMP}.json"
          echo "âœ… å·²å½’æ¡£åŸå§‹ä»·æ ¼æ•°æ®"
        fi
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          cp spotify_prices_cny_sorted.json "${ARCHIVE_DIR}/spotify_prices_cny_sorted_${TIMESTAMP}.json"
          echo "âœ… å·²å½’æ¡£è½¬æ¢åä»·æ ¼æ•°æ®"
        fi
        echo "å½’æ¡£å®Œæˆï¼Œæ–‡ä»¶ä¿å­˜åœ¨: ${ARCHIVE_DIR}"
        
    - name: Detect price changes and generate changelog
      id: price_changes
      if: steps.scraper.outputs.scraper_status == 'success' && steps.converter.outputs.converter_status == 'success'
      run: |
        echo "ğŸ” å¼€å§‹æ£€æµ‹ä»·æ ¼å˜åŒ–..."
        python price_change_detector.py
        
        # æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœå¹¶è®¾ç½®é»˜è®¤å€¼
        if [ ! -f "$GITHUB_OUTPUT" ] || ! grep -q "changes_count=" "$GITHUB_OUTPUT" 2>/dev/null; then
          echo "changes_count=0" >> $GITHUB_OUTPUT
          echo "summary_file=" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # åˆ†åˆ«æ·»åŠ å­˜åœ¨çš„æ–‡ä»¶ï¼Œé¿å… git add å¤±è´¥
        git add . || echo "Adding all changes"
        
        # æ„å»ºæäº¤ä¿¡æ¯
        COMMIT_MSG="Weekly update: Spotify prices and archive data - $(date +'%Y-%m-%d %H:%M:%S %Z')"
        if [ "${{ steps.price_changes.outputs.changes_count }}" != "0" ] && [ "${{ steps.price_changes.outputs.changes_count }}" != "" ]; then
          COMMIT_MSG="${COMMIT_MSG} [å‘ç° ${{ steps.price_changes.outputs.changes_count }} é¡¹ä»·æ ¼å˜åŒ–]"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ CHANGELOG å½’æ¡£
        if [ -d "changelog_archive" ] && [ -n "$(find changelog_archive -name "*.md" -type f 2>/dev/null)" ]; then
          # è®¡ç®—ä¸Šä¸ªæœˆï¼ˆå¤„ç†è·¨å¹´æƒ…å†µï¼‰
          CURRENT_YEAR=$(date +'%Y')
          CURRENT_MONTH=$(date +'%m')
          if [ "$CURRENT_MONTH" = "01" ]; then
            LAST_YEAR=$((CURRENT_YEAR - 1))
            LAST_MONTH="${LAST_YEAR}-12"
          else
            LAST_MONTH_NUM=$((10#$CURRENT_MONTH - 1))
            LAST_MONTH="${CURRENT_YEAR}-$(printf '%02d' $LAST_MONTH_NUM)"
          fi
          
          ARCHIVED_COUNT=$(find changelog_archive -name "changelog_${LAST_MONTH}*.md" -type f 2>/dev/null | wc -l)
          if [ "$ARCHIVED_COUNT" -gt 0 ]; then
            COMMIT_MSG="${COMMIT_MSG} [å½’æ¡£CHANGELOG]"
          fi
        fi
        
        git commit -m "${COMMIT_MSG}"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
        echo "âœ… æ•°æ®å·²æäº¤åˆ°ä»“åº“"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: spotify-price-data-${{ github.run_number }}
        path: |
          spotify_prices_all_countries*.json
          spotify_prices_cny_sorted.json
          CHANGELOG.md
          changelog_archive/
          price_changes_summary_*.json
        retention-days: 30
        
    - name: Job summary
      if: always()
      run: |
        echo "## ğŸµ Spotify ä»·æ ¼çˆ¬è™«æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "**çˆ¬è™«çŠ¶æ€:** ${{ steps.scraper.outputs.scraper_status || 'å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
        echo "**è½¬æ¢çŠ¶æ€:** ${{ steps.converter.outputs.converter_status || 'å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ–‡ä»¶å˜åŒ–:** ${{ steps.check_changes.outputs.changes || 'å¦' }}" >> $GITHUB_STEP_SUMMARY
        
        # ä»·æ ¼å˜åŒ–ä¿¡æ¯
        CHANGES_COUNT="${{ steps.price_changes.outputs.changes_count }}"
        if [ "$CHANGES_COUNT" != "" ] && [ "$CHANGES_COUNT" != "0" ]; then
          echo "**ä»·æ ¼å˜åŒ–:** ğŸ”„ å‘ç° $CHANGES_COUNT é¡¹å˜åŒ–" >> $GITHUB_STEP_SUMMARY
        elif [ "$CHANGES_COUNT" = "0" ]; then
          echo "**ä»·æ ¼å˜åŒ–:** âœ… æ— å˜åŒ–" >> $GITHUB_STEP_SUMMARY
        else
          echo "**ä»·æ ¼å˜åŒ–:** âš ï¸ æ£€æµ‹å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          echo "**è¾“å‡ºæ–‡ä»¶å¤§å°:** $(du -h spotify_prices_cny_sorted.json | cut -f1)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºå½’æ¡£ä¿¡æ¯
        YEAR=$(date +'%Y')
        MONTH=$(date +'%m')
        ARCHIVE_DIR="archive/${YEAR}/${MONTH}"
        if [ -d "${ARCHIVE_DIR}" ] && [ -n "$(ls -A ${ARCHIVE_DIR} 2>/dev/null)" ]; then
          echo "**å½’æ¡£çŠ¶æ€:** âœ… å·²å½’æ¡£åˆ° ${ARCHIVE_DIR}" >> $GITHUB_STEP_SUMMARY
          echo "**å½’æ¡£æ–‡ä»¶æ•°é‡:** $(ls ${ARCHIVE_DIR}/*$(date +'%Y%m%d')* 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        else
          echo "**å½’æ¡£çŠ¶æ€:** âŒ æœªå½’æ¡£" >> $GITHUB_STEP_SUMMARY
        fi
        
        # å¦‚æœæœ‰ä»·æ ¼å˜åŒ–ï¼Œæ˜¾ç¤ºchangelogé“¾æ¥
        if [ -f "CHANGELOG.md" ] && [ "$CHANGES_COUNT" != "0" ] && [ "$CHANGES_COUNT" != "" ]; then
          echo "**å˜åŒ–è¯¦æƒ…:** ğŸ“‹ æŸ¥çœ‹ [CHANGELOG.md](./CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤º CHANGELOG å½’æ¡£ä¿¡æ¯
        if [ -d "changelog_archive" ]; then
          ARCHIVE_COUNT=$(find changelog_archive -name "*.md" -type f 2>/dev/null | wc -l)
          if [ "$ARCHIVE_COUNT" -gt 0 ]; then
            echo "**CHANGELOGå½’æ¡£:** ğŸ“š å…± $ARCHIVE_COUNT ä¸ªæœˆåº¦å½’æ¡£" >> $GITHUB_STEP_SUMMARY
            # æ£€æŸ¥æœ¬æ¬¡æ˜¯å¦æ–°å¢äº†å½’æ¡£ï¼ˆæ£€æŸ¥ä¸Šä¸ªæœˆï¼Œå¤„ç†è·¨å¹´æƒ…å†µï¼‰
            CURRENT_YEAR=$(date +'%Y')
            CURRENT_MONTH=$(date +'%m')
            if [ "$CURRENT_MONTH" = "01" ]; then
              LAST_YEAR=$((CURRENT_YEAR - 1))
              LAST_MONTH="${LAST_YEAR}-12"
            else
              LAST_MONTH_NUM=$((10#$CURRENT_MONTH - 1))
              LAST_MONTH="${CURRENT_YEAR}-$(printf '%02d' $LAST_MONTH_NUM)"
            fi
            
            LAST_MONTH_ARCHIVE=$(find changelog_archive -name "changelog_${LAST_MONTH}*.md" -type f 2>/dev/null | wc -l)
            if [ "$LAST_MONTH_ARCHIVE" -gt 0 ]; then
              echo "**æœ¬æ¬¡å½’æ¡£:** âœ… å·²å½’æ¡£ä¸Šæœˆè®°å½•" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        fi
