name: Weekly Spotify Price Scraper

on:
  schedule:
    # æ¯å‘¨æ—¥UTCæ—¶é—´0ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´å‘¨æ—¥ä¸Šåˆ8ç‚¹ï¼‰
    - cron: '0 0 * * 0'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright browsers
      run: |
        playwright install chromium
        # å®‰è£…ç³»ç»Ÿä¾èµ–
        playwright install-deps chromium
        
    - name: Create output directory
      run: mkdir -p output
        
    - name: Run Spotify scraper
      id: scraper
      env:
        # Playwright ç¯å¢ƒå˜é‡
        PLAYWRIGHT_BROWSERS_PATH: 0
        PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 0
      run: |
        echo "å¼€å§‹çˆ¬å–Spotifyä»·æ ¼æ•°æ®..."
        python spotify.py
        echo "scraper_status=success" >> $GITHUB_OUTPUT
      continue-on-error: true
        
    - name: Check scraper output
      run: |
        if [ -f "spotify_prices_all_countries.json" ]; then
          echo "âœ… çˆ¬è™«æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          ls -la spotify_prices_all_countries*.json
        else
          echo "âŒ çˆ¬è™«æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
    - name: Run rate converter
      id: converter
      env:
        API_KEY: ${{ secrets.API_KEY }}
      run: |
        echo "å¼€å§‹æ±‡ç‡è½¬æ¢..."
        python spotify_rate_converter.py
        echo "converter_status=success" >> $GITHUB_OUTPUT
      continue-on-error: true
        
    - name: Check converter output
      run: |
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          echo "âœ… æ±‡ç‡è½¬æ¢æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          ls -la spotify_prices_cny_sorted.json
        else
          echo "âŒ æ±‡ç‡è½¬æ¢æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
    - name: Check for changes
      id: check_changes
      run: |
        git diff --name-only
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–"
        fi
        
    - name: Display summary
      run: |
        echo "=== æ‰§è¡Œæ‘˜è¦ ==="
        echo "æ—¥æœŸ: $(date +'%Y-%m-%d %H:%M:%S %Z')"
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          echo "è½¬æ¢åçš„æ•°æ®æ–‡ä»¶å¤§å°: $(du -h spotify_prices_cny_sorted.json | cut -f1)"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < spotify_prices_cny_sorted.json)"
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add *.json
        git commit -m "Weekly update: Spotify prices - $(date +'%Y-%m-%d %H:%M:%S %Z')"
        git push
        echo "âœ… æ•°æ®å·²æäº¤åˆ°ä»“åº“"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: spotify-price-data-${{ github.run_number }}
        path: |
          spotify_prices_all_countries*.json
          spotify_prices_cny_sorted.json
        retention-days: 30
        
    - name: Job summary
      if: always()
      run: |
        echo "## ğŸµ Spotify ä»·æ ¼çˆ¬è™«æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "**çˆ¬è™«çŠ¶æ€:** ${{ steps.scraper.outputs.scraper_status || 'å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
        echo "**è½¬æ¢çŠ¶æ€:** ${{ steps.converter.outputs.converter_status || 'å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ–‡ä»¶å˜åŒ–:** ${{ steps.check_changes.outputs.changes || 'å¦' }}" >> $GITHUB_STEP_SUMMARY
        if [ -f "spotify_prices_cny_sorted.json" ]; then
          echo "**è¾“å‡ºæ–‡ä»¶å¤§å°:** $(du -h spotify_prices_cny_sorted.json | cut -f1)" >> $GITHUB_STEP_SUMMARY
        fi
